import"../chunks/DsnmJJEf.js";import"../chunks/Cimollut.js";import{o as Rn}from"../chunks/B_jID4d2.js";import{p as Nn,f as Gt,c as I,b as v,a as Jt,i as kn,j as Mn,e as oe,$ as Ln,r as C}from"../chunks/Nxf_S6m2.js";import{h as $n}from"../chunks/BKk_KKHJ.js";import{i as An}from"../chunks/DIW6s7ce.js";var Fn=Gt('<meta charset="utf-8"/> <meta name="viewport" content="width=device-width, initial-scale=1"/>',1),Tn=Gt('<div id="demo2Root" class="mode-basic"><div id="overlay"><div><div class="spinner"></div><div style="text-align:center; margin-top:8px; color:#fff;" id="overlayMsg">processing...</div></div></div> <div id="noticeModal"><div class="noticeCard"><div class="noticeTitle">ご注意</div> <div id="noticeMessage" class="noticeMessage"></div> <div class="noticeActions"><button id="noticeClose">OK</button></div></div></div> <div id="labelModal"><div class="noticeCard"><div class="noticeTitle">ラベル編集</div> <div id="labelEditMessage" class="noticeMessage"></div> <div class="modalField" style="margin-top:16px;"><label for="labelEditSelect">数値ラベル</label> <select id="labelEditSelect" style="width:100%;"><option>0</option><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option><option>6</option><option>7</option><option>8</option><option>9</option></select></div> <div class="modalField"><label for="labelEditNameInput">表示名 (任意)</label> <input id="labelEditNameInput" type="text" placeholder="例: 腕の振り" style="width:100%;"/></div> <div class="muted" style="font-size:12px; margin-top:8px;">※表示名を変更すると同じ番号のラベル全てに反映されます</div> <div class="noticeActions" style="gap:8px; margin-top:16px;"><button id="labelEditCancel">キャンセル</button> <button id="labelEditOk" class="btn-theme">OK</button></div></div></div> <div id="confirmModal"><div class="noticeCard"><div class="noticeTitle">削除確認</div> <div id="confirmMessage" class="noticeMessage"></div> <div class="noticeActions" style="gap:8px;"><button id="confirmCancel">キャンセル</button> <button id="confirmOk" class="btn-theme">OK</button></div></div></div> <div class="wrap"><h1>micro:bitの加速度センサーを使ったジェスチャー分類デモ</h1> <img src="/assets/image-demo2.jpg" width="640" height="360" alt="" style="margin-bottom: 16px;"/> <div class="row" style="align-items:center; gap:16px; margin-bottom:8px;"><div class="muted">ver.260105</div> <div class="modeToggle" role="group" aria-label="表示モード"><button type="button" class="modeBtn active" data-mode="basic" aria-pressed="true">Basic</button> <button type="button" class="modeBtn" data-mode="advanced" aria-pressed="false">Advanced</button></div></div> <div class="muted" style="margin-bottom:8px;">使い方: Connect + Start Notify ▶︎ ラベル選択ー波形取得開始（複数回） ▶︎ 学習 + 評価 ▶︎ 推論開始</div> <div class="card"><div class="row"><button id="btnConnect" class="btn-theme btn-connect">Connect + Start Notify</button> <button id="btnStop" class="btn-stop-notify">Stop Notify</button> <span class="pill">Device: <span id="devName" class="muted">-</span></span> <span class="pill">State: <span id="state" class="muted">idle</span></span></div> <div class="row" style="margin-top:8px; align-items:center;"><span class="advancedOnly" style="display:inline-flex; align-items:center; gap:6px;"><label for="recordSeconds">取得秒数:</label> <input id="recordSeconds" type="number" value="10" step="1" min="1" style="width:90px;"/></span> <label for="labelSel">ラベル:</label> <select id="labelSel"><option>0</option><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option><option>6</option><option>7</option><option>8</option><option>9</option></select> <button id="btnRecStart" class="btn-theme btn-rec-start">波形取得開始</button> <span class="pill">収録セグメント数: <span id="nSegs" class="muted">0</span></span></div> <div class="row advancedOnly" style="margin-top:6px; gap:8px; align-items:center; flex-wrap:wrap;"><label for="labelNameInput" class="muted" style="font-size:13px;">ラベル表示名:</label> <input id="labelNameInput" type="text" placeholder="任意の表示名" style="flex:1; min-width:220px;"/> <span class="muted" style="font-size:12px;">未入力時は番号のみ表示</span></div> <div class="row advancedOnly" style="margin-top:8px; display:flex; flex-wrap:nowrap; align-items:center; gap:8px;"><label for="noteInput">メモ:</label> <input id="noteInput" type="text" placeholder="任意のメモ" style="flex:1; min-width:320px;"/></div> <div class="row advancedOnly" style="margin-top:8px;"><label for="nRes">ノード数</label> <input id="nRes" type="number" step="10" value="300" min="10"/> <label for="spectralRadius">スペクトル半径</label> <input id="spectralRadius" type="number" step="0.05" value="0.90"/> <label for="leakRate">リーク率</label> <input id="leakRate" type="number" step="0.05" value="0.80" min="0" max="1"/> <label for="density">結合密度</label> <input id="density" type="number" step="0.05" value="0.10" min="0" max="1"/> <label for="ridgeLambda">リッジλ</label> <input id="ridgeLambda" type="number" step="0.01" value="0.05" min="0"/></div> <div class="row" style="margin-top:8px;"><div class="advancedOnly advancedGroup"><span>使用軸:</span> <label class="axisChk"><input type="checkbox" id="axisX" checked/>x</label> <label class="axisChk"><input type="checkbox" id="axisY" checked/>y</label> <label class="axisChk"><input type="checkbox" id="axisZ" checked/>z</label></div> <div class="advancedOnly advancedGroup"><label for="splitRatio" class="muted" style="font-size:13px;">train/eval:</label> <select id="splitRatio"><option selected>100:0</option><option>90:10</option><option>80:20</option><option>70:30</option></select></div> <button id="btnTrain" class="btn-theme btn-train">学習 + 評価</button> <span class="pill">学習済: <span id="trained" class="muted">No</span></span> <span class="pill">学習精度: <span id="evalAccuracy" class="muted">-</span></span></div> <div class="row" style="margin-top:8px;"><label for="emaAlpha" class="muted advancedOnly advancedGroup">EMA α: <input id="emaAlpha" type="number" step="0.05" value="0.10" style="width:80px;"/></label> <button id="btnInferStart" class="btn-theme btn-infer-start">推論開始</button> <button id="btnInferStop" class="btn-infer-stop">停止</button></div> <div class="row" style="margin-top:12px; align-items:flex-end;"><div class="predWrapper"><div id="predLabel" class="predLabel">推論予測</div> <div id="pred" class="predDisplay">-</div></div></div> <div class="row" style="margin-top:8px;"><span class="pill"><span id="secondaryLabel">確率</span>: <span id="secondaryValue" class="mono">-</span></span></div> <div class="row" style="margin-top:8px;"><div class="chartWrap"><canvas id="chart"></canvas></div></div></div> <div class="card" id="dataManagementCard"><div class="row"><strong class="advancedOnly">データ管理</strong> <button id="btnZip" class="advancedOnly btn-theme btn-zip">ZIPダウンロード</button> <button id="btnZipSelect" class="advancedOnly btn-theme">ファイル選択</button> <input id="zipInput" class="advancedOnly" type="file" accept=".zip" style="display:none;"/> <span id="zipStatus" class="advancedOnly muted small">選択されていません</span></div> <div style="margin-top:8px;" class="muted advancedOnly">収録/インポート済みセグメント一覧</div> <div id="segList" class="mono" style="max-height:280px; overflow:auto; background:#030712; border-radius:10px; padding:8px;"></div></div> <div class="card advancedOnly"><div class="muted">ログ</div> <pre id="log" class="mono" style="white-space:pre-wrap; max-height:260px; overflow:auto;"></pre></div></div></div>');function Bn(Ht,Xt){Nn(Xt,!1);const Kt=[{id:"numericjs-script",src:"https://cdn.jsdelivr.net/npm/numericjs@1.2.6/numeric-1.2.6.min.js"},{id:"jszip-script",src:"https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"},{id:"bluejelly-script",src:"/demo2/bluejelly.js"},{id:"smoothie-script",src:"/demo2/smoothie.js"}];function Qt({id:_,src:w}){return new Promise((i,z)=>{if(typeof document>"u"){z(new Error("document is undefined"));return}const q=document.getElementById(_);if(q){q.dataset.loaded==="true"?i(q):(q.addEventListener("load",()=>i(q),{once:!0}),q.addEventListener("error",()=>z(new Error(`failed to load ${w}`)),{once:!0}));return}const x=document.createElement("script");x.id=_,x.src=w,x.defer=!0,x.dataset.loaded="false",x.addEventListener("load",()=>{x.dataset.loaded="true",i(x)}),x.addEventListener("error",()=>z(new Error(`failed to load ${w}`))),document.head.appendChild(x)})}function dt(_){if(typeof document>"u")return;const w=_,i=document.getElementById(w);if(!i||i.dataset.modeToggleReady==="true")return;function z(x){const $=x==="advanced"?"advanced":"basic";i.classList.remove("mode-basic","mode-advanced"),i.classList.add(`mode-${$}`),i.querySelectorAll(".modeToggle button").forEach(re=>{const ce=re.dataset.mode===$;re.classList.toggle("active",ce),re.setAttribute("aria-pressed",ce?"true":"false")})}i.dataset.modeToggleReady="true",i.addEventListener("click",x=>{const $=x.target;if(!$||typeof $.closest!="function")return;const se=$.closest(".modeToggle button[data-mode]");se&&z(se.dataset.mode==="advanced"?"advanced":"basic")});const q=i.classList.contains("mode-advanced")?"advanced":"basic";z(q)}function en(_){const w=_,i=document.getElementById(w);if(!i){console.warn("demo2 root not found");return}function z(e,t,n=40,a){if(!t)return 0;const l=new Float32Array(t);let o=0;for(let p=0;p<t;p++){const r=(a?a():Math.random())*2-1;l[p]=r,o+=r*r}(!isFinite(o)||o===0)&&(l.fill(0),l[0]=1,o=1),o=Math.sqrt(o);for(let p=0;p<t;p++)l[p]/=o;const s=new Float32Array(t);let d=0;for(let p=0;p<n;p++){for(let r=0;r<t;r++){let m=0;const c=r*t;for(let g=0;g<t;g++)m+=e[c+g]*l[g];s[r]=m}let u=0;for(let r=0;r<t;r++)u+=s[r]*s[r];if(u=Math.sqrt(u),!isFinite(u)||u===0){d=0;break}for(let r=0;r<t;r++)l[r]=s[r]/u;d=u}return d}class q{constructor(t,n,a,{spectralRadius:l=.9,density:o=.1,leak:s=.8,seed:d=0}={}){this.nIn=t,this.nRes=n,this.nOut=a,this.leak=s,this.seed=d|0;const p=this._rng();this.W_in=new Float32Array(n*t);for(let c=0;c<this.W_in.length;c++)this.W_in[c]=(p()*2-1)*.5;this.W_res=new Float32Array(n*n);for(let c=0;c<n;c++){const g=c*n;for(let b=0;b<n;b++){const S=p();this.W_res[g+b]=S<o?p()*2-1:0}}const u=Math.abs(l),r=z(this.W_res,n,40,p),m=r>0?u/r:u;for(let c=0;c<this.W_res.length;c++)this.W_res[c]*=m;this.x=new Float32Array(n),this.W_out=null}_rng(){let t=this.seed>>>0||1;return()=>(t=t*1664525+1013904223>>>0,(t&65535)/65535)}reset(){this.x.fill(0)}step(t){const n=this.nRes,a=this.nIn,l=this.leak,o=new Float32Array(n);for(let s=0;s<n;s++){let d=0,p=s*a,u=s*n;for(let r=0;r<a;r++)d+=this.W_in[p+r]*t[r];for(let r=0;r<n;r++)d+=this.W_res[u+r]*this.x[r];o[s]=Math.tanh(d)}for(let s=0;s<n;s++)this.x[s]=(1-l)*this.x[s]+l*o[s];return this.x}}function x(e,t){const n=new Array(t).fill(0);return n[e]=1,n}function $(e){const t=Math.max(...e),n=e.map(l=>Math.exp(l-t)),a=n.reduce((l,o)=>l+o,0)||1;return n.map(l=>l/a)}function se(e,t,n=.05){const a=numeric.svd(e),l=a.U,o=a.S,s=a.V,d=o.map(r=>r/(r*r+n)),p=numeric.dot(numeric.transpose(l),t),u=s.map((r,m)=>r.map(c=>c*(d[m]||0)));return numeric.dot(u,p)}function re(e,t,n,a,l=.05){const o=[],s=[];for(let d=0;d<t.length;d++){const p=t[d],u=n[d];e.reset();for(let r=0;r<p.length;r++){const c=[1,...e.step(p[r])];o.push(c),s.push(x(u,a))}}e.W_out=se(o,s,l)}function ce(e,t){e.reset();const n=[];for(let o=0;o<t.length;o++){const d=[1,...e.step(t[o])],p=numeric.dot(d,e.W_out);n.push($(Array.from(p)))}const a=e.W_out[0].length,l=new Array(a).fill(0);for(const o of n)for(let s=0;s<a;s++)l[s]+=o[s];for(let o=0;o<a;o++)l[o]/=n.length;return l}function tn(e,t){return e.map(n=>t.map(a=>n[a]))}function nn(e){let t=Number((BigInt(e)||0n)&0xffffffffn);return t||(t=1),{next:()=>(t=t*1664525+1013904223>>>0,(t>>>0)/4294967296),snapshot:()=>BigInt(t>>>0).toString()}}function an(e,t,n){const a=Math.min(Math.max(isFinite(n)?n:.8,0),1),l=Math.min(Math.max(1-a,0),1),o=Array.from(new Set(e)).sort((p,u)=>p-u),s=[],d=[];for(const p of o){const u=[];for(let m=0;m<e.length;m++)e[m]===p&&u.push(m);if(u.length<=1){s.push(...u);continue}for(let m=u.length-1;m>0;m--){const c=Math.floor(t.next()*(m+1));[u[m],u[c]]=[u[c],u[m]]}let r=Math.round(u.length*l);l>0&&r===0&&(r=1),r>=u.length&&(r=u.length-1),r<0&&(r=0),d.push(...u.slice(0,r)),s.push(...u.slice(r))}return{trainIdx:s,valIdx:d}}function ln(e){return Array.from({length:e},()=>Array(e).fill(0))}function on(e){const{segments:t,selectedAxes:n,params:a,shuffleSeed:l,trainRatio:o}=e,s=n,d=t.map(h=>h.lab),p=Math.max(...d,0)+1,u=nn(l),r=Math.min(Math.max(isFinite(o)?o:.8,0),1),{trainIdx:m,valIdx:c}=an(d,u,r),g=t.map(h=>tn(h.seq,s)),b=m.map(h=>g[h]),S=m.map(h=>d[h]),k=c.length?c:m,ct=!c.length,W=k.map(h=>g[h]),qn=k.map(h=>d[h]),ie=new q(s.length,a.nRes,p,{spectralRadius:a.spectralRadius,density:a.density,leak:a.leak,seed:0});re(ie,b,S,p,a.ridge);let Vt=null;if(b.length){let h=0;for(let K=0;K<b.length;K++){const V=ce(ie,b[K]);V.indexOf(Math.max(...V))===S[K]&&h++}Vt={count:b.length,acc:h/Math.max(1,b.length)}}let Yt=null;if(W.length){const h=ln(p);let K=0;for(let V=0;V<W.length;V++){const Se=ce(ie,W[V]),Ce=Se.indexOf(Math.max(...Se)),qe=qn[V];qe>=0&&qe<p&&Ce>=0&&Ce<p&&h[qe][Ce]++,Ce===qe&&K++}Yt={count:W.length,acc:K/Math.max(1,W.length),conf:h,labels:Array.from({length:p},(V,Se)=>Se),usingTrainData:ct}}return{esn:{nIn:s.length,nRes:a.nRes,nOut:p,W_in:Array.from(ie.W_in),W_res:Array.from(ie.W_res),W_out:ie.W_out},trainSegments:m.length,evalSegments:k.length,trainResult:Vt,evalResult:Yt,shuffleSeed:u.snapshot(),trainRatio:r}}function sn(e,t){return Promise.resolve(on(t))}const D=new BlueJelly;D.setUUID("ACC",BlueJelly.MICROBIT_ACCELEROMETER_SERVICE,BlueJelly.MICROBIT_ACCELEROMETER_DATA);const Ke=new TimeSeries,Qe=new TimeSeries,et=new TimeSeries;function rn(){const e=i.querySelector("#chart");if(!e)return;const t=e.parentElement,n=new SmoothieChart({millisPerPixel:20,grid:{fillStyle:"#0b1220",strokeStyle:"#1f2937",millisPerLine:800},maxValue:3,minValue:-3});n.addTimeSeries(Ke,{strokeStyle:"rgba(56,189,248,1)",lineWidth:2}),n.addTimeSeries(Qe,{strokeStyle:"rgba(34,197,94,1)",lineWidth:2}),n.addTimeSeries(et,{strokeStyle:"rgba(244,63,94,1)",lineWidth:2}),n.streamTo(e,500);function a(){const l=t?t.getBoundingClientRect():e.getBoundingClientRect(),o=Math.max(1,Math.floor(l.width||0)),s=Math.max(1,Math.floor(l.height||200));(e.width!==o||e.height!==s)&&(e.width=o,e.height=s),e.style.width=`${o}px`,e.style.height=`${s}px`,e.style.maxWidth="100%"}if(a(),typeof ResizeObserver<"u"){const l=new ResizeObserver(a);t?l.observe(t):l.observe(e)}window.addEventListener("resize",a)}function cn(){return{type:"identity"}}function dn(e,t=xe){return t.map(n=>e[n])}const _t=50;let tt=new Float32Array(100),Et=new Float32Array(100),It=new Float32Array(100),Q=0,M=!1,ee=[],A=null,Ct=0,y=[],de=null,R=null,j=!1,E=null,nt=!1,te=null,N=null,xe=[0,1,2];const un=["axisX","axisY","axisZ"],pn=["x","y","z"];let qt=null,Rt=0x123456789abcdefn,F=null,P=!1,ne=null,T=null,ae={},Y={labelIndex:null,detail:"-"};const Nt=i.querySelector("#predLabel"),kt=i.querySelector("#pred"),ue=i.querySelector("#secondaryLabel"),pe=i.querySelector("#secondaryValue");i.querySelectorAll(".modeToggle button"),dt(w),B("devName","-",!1),B("state","idle",!1);function fe(e,t,n,a){Nt&&(Nt.textContent=e),kt&&(kt.textContent=t),ue&&(ue.textContent=n,ue.classList.add("secondaryLabel")),pe&&(pe.textContent=a,pe.classList.add("secondaryValue"))}function me(e,t){e&&(t?(e.classList.add("okText"),e.classList.remove("muted")):(e.classList.remove("okText"),e.classList.add("muted")))}function B(e,t,n){const a=e&&e.startsWith("#")?e:`#${e}`,l=i.querySelector(a);l&&(typeof t<"u"&&(l.textContent=t),typeof n=="boolean"&&me(l,n))}function ve(){Y={labelIndex:null,detail:"-"},fe("カウンタ","-","記録","-")}function Mt(e){fe("カウンタ",e,"記録","-")}function fn(){fe("カウンタ","REC","記録","0.0s")}function mn(e){ue&&(ue.textContent="記録"),pe&&(pe.textContent=`${e.toFixed(1)}s`)}function vn(){const e=i.querySelector("#recordSeconds");let t=parseFloat(e&&e.value);(!isFinite(t)||t<=0)&&(t=10);const n=Math.max(1,t);return e&&(e.value=String(n)),n}function le(e){const t=ae[e];return typeof t=="string"?t.trim():""}function at(e,t,{allowEmptyClear:n=!1}={}){const a=Number.isFinite(e)?e:parseInt(e,10);if(!Number.isFinite(a))return!1;const l=(t||"").trim(),o=le(a);return l?o===l?!1:(ae[a]=l,!0):!n||!o?!1:(delete ae[a],!0)}function L(e){const t=Number.isFinite(e)?e:parseInt(e,10);if(!Number.isFinite(t))return"-";const n=le(t),a=String(t);return n?`${a}:${n}`:a}function J(){const e=i.querySelector("#labelSel");e&&Array.from(e.options||[]).forEach(t=>{const n=parseInt(t.value,10);isNaN(n)||(t.textContent=L(n))})}function Z(){const e=i.querySelector("#labelEditSelect");e&&Array.from(e.options||[]).forEach(t=>{const n=parseInt(t.value,10);isNaN(n)||(t.textContent=L(n))})}function U(){const e=i.querySelector("#labelSel"),t=i.querySelector("#labelNameInput");if(!e||!t)return;const n=parseInt(e.value,10),a=le(n);t.value=a||"",t.placeholder=a||"任意の表示名"}function yn(){const e=i.querySelector("#labelSel"),t=i.querySelector("#labelNameInput");if(!e||!t)return;const n=parseInt(e.value,10);if(Number.isNaN(n))return;at(n,t.value,{allowEmptyClear:!0})&&(J(),Z(),X(),G(),U(),O())}function O(){const e=i.querySelector("#labelEditSelect"),t=i.querySelector("#labelEditNameInput");if(!e||!t)return;const n=parseInt(e.value,10);t.value=Number.isNaN(n)?"":le(n)||"",t.placeholder=(Number.isNaN(n),"例: 腕の振り")}function G(){N!==null?Lt(N):j?we(Y.labelIndex,Y.detail):M||ve()}function we(e,t,{suppressUI:n=!1}={}){const a=typeof e=="number"&&e>=0?e:null;if(Y={labelIndex:a,detail:t},n)return;const l=a!==null?L(a):"-";fe("推論予測",l,"確率",t)}function Lt(e){const t=y[e],n=t?L(t.lab):"-",a=typeof e=="number"&&e>=0?`#${e}`:"-";fe("再生中",a,"ラベル=",n)}function _e(e){const t=i.querySelector("#trained");t&&(t.textContent=e?"Yes":"No",me(t,!!e));const n=i.querySelector("#evalAccuracy");!e&&n&&(n.textContent="-",me(n,!1))}function Ee(e){const t=!!R||!!de||!!E,n=j;R=null,de=null,E=null,j=!1,qt=null,_e(!1),!M&&N===null&&ve(),n&&f("モデルクリアに伴い推論を停止しました"),e&&(t||n)&&f(e)}function bn({save:e=!0,reason:t}={}){if(!M){t&&f(t);return}if(M=!1,A&&(clearInterval(A),A=null),t&&f(t),e)if(ee.length>0){const n=parseInt(i.querySelector("#labelSel").value,10)||0,a=i.querySelector("#labelNameInput");a&&at(n,a.value,{allowEmptyClear:!0})&&f(`label display updated: label=${L(n)}`),y.push({lab:n,seq:ee.slice()}),f("segment saved: len="+ee.length+", lab="+n),Ee("新しい波形を保存したため学習モデルをクリアしました")}else f("録音データが空のため保存しませんでした");else f("録音をキャンセルしました");ee=[],X(),J(),Z(),U(),O(),G()}function H(e){const t=i.querySelector("#noticeModal"),n=i.querySelector("#noticeMessage");if(!t||!n){window.alert(e);return}n.textContent=e,t.style.display="flex";const a=i.querySelector("#noticeClose");a&&a.focus()}function lt(){const e=i.querySelector("#noticeModal");e&&(e.style.display="none")}function ye(e,t={}){const{checkInfer:n=!0,checkTrain:a=!0,checkRecord:l=!0}=t;return n&&j?(H(`推論中は${e}できません。推論を停止してから再度お試しください。`),!0):a&&nt?(H(`学習中は${e}できません。学習が完了してから再度お試しください。`),!0):l&&M?(H(`波形取得中は${e}できません。取得を停止してから再度お試しください。`),!0):!1}const it=i.querySelector("#noticeModal");it&&it.addEventListener("click",e=>{e.target===it&&lt()});const $t=i.querySelector("#noticeClose");$t&&$t.addEventListener("click",()=>lt());const ot=i.querySelector("#confirmModal");ot&&ot.addEventListener("click",e=>{e.target===ot&&(ne=null,Ie())});const At=i.querySelector("#confirmCancel");At&&At.addEventListener("click",()=>{ne=null,Ie()});const Ft=i.querySelector("#confirmOk");Ft&&Ft.addEventListener("click",()=>{const e=ne;ne=null,Ie(),typeof e=="number"&&En(e)});const st=i.querySelector("#labelModal");st&&st.addEventListener("click",e=>{e.target===st&&(T=null,he())});const Tt=i.querySelector("#labelEditCancel");Tt&&Tt.addEventListener("click",()=>{T=null,he()});const Ot=i.querySelector("#labelEditOk");Ot&&Ot.addEventListener("click",()=>{Cn()});const Wt=i.querySelector("#labelEditSelect");Wt&&Wt.addEventListener("change",()=>O());const zt=i.querySelector("#labelEditNameInput");zt&&zt.addEventListener("keydown",e=>{e.key==="Enter"&&e.preventDefault()});const Dt=i.querySelector("#labelSel");Dt&&Dt.addEventListener("change",()=>{U()});const jt=i.querySelector("#labelNameInput");jt&&jt.addEventListener("change",()=>yn());const be=i.querySelector("#zipInput"),Pt=i.querySelector("#zipStatus"),Bt=i.querySelector("#btnZipSelect");Bt&&be&&Bt.addEventListener("click",()=>{be.click()}),document.addEventListener("keydown",e=>{e.key==="Escape"&&(lt(),ne=null,Ie(),T=null,he())});function gn(){const e=parseFloat(i.querySelector("#spectralRadius").value||"0.9"),t=parseFloat(i.querySelector("#leakRate").value||"0.8"),n=parseInt(i.querySelector("#nRes").value||"300",10),a=parseFloat(i.querySelector("#density").value||"0.1"),l=parseFloat(i.querySelector("#ridgeLambda").value||"0.05");return{spectralRadius:isFinite(e)?e:.9,leak:isFinite(t)?t:.8,nRes:isFinite(n)&&n>0?n:300,density:Math.min(Math.max(isFinite(a)?a:.1,0),1),ridge:Math.max(isFinite(l)?l:.05,0)}}function hn(){const e=[];return un.forEach((t,n)=>{const a=i.querySelector(`#${t}`);a&&a.checked&&e.push(n)}),e}function Sn(e){return e.map(t=>pn[t]).join("/")}function f(e){const t=i.querySelector("#log");t.textContent+=e+`
`,t.scrollTop=t.scrollHeight}function Zt(e="processing..."){const t=i.querySelector("#overlay");i.querySelector("#overlayMsg").textContent=e,t.style.display="flex"}function Ut(){i.querySelector("#overlay").style.display="none"}function X(){const e=i.querySelector("#segList"),t=i.querySelector("#nSegs");if(t&&(t.textContent=String(y.length),me(t,y.length>0)),!!e){if(e.innerHTML="",y.length===0){e.textContent="(no segments)";return}y.forEach((n,a)=>{const l=document.createElement("div");l.className="segRow";const o=document.createElement("span");o.className="segInfo";const s=document.createElement("span");s.textContent=`#${a}`,o.appendChild(s);const d=document.createElement("a");d.href="#",d.className="segLabelLink",d.textContent=`label=${L(n.lab)}`,d.addEventListener("click",r=>{r.preventDefault(),In(a)}),o.appendChild(d);const p=document.createElement("span");p.textContent=`length=${n.seq.length}`,o.appendChild(p),l.appendChild(o);const u=document.createElement("span");u.className="segActions",u.appendChild(rt("再生",()=>xn(a))),u.appendChild(rt("停止",()=>wn(a))),u.appendChild(rt("削除",()=>_n(a))),l.appendChild(u),e.appendChild(l)})}}function rt(e,t){const n=document.createElement("a");return n.href="#",n.textContent=e,n.addEventListener("click",a=>{a.preventDefault(),t()}),n}function xn(e){if(!(e>=0&&e<y.length)){f("プレビュー対象が不正です");return}const t=y[e].seq;if(!t||!t.length){f(`preview skipped: #${e} は空です`);return}ge({log:!1,silentIfIdle:!0}),N=e;let n=0;f(`preview start: #${e}, len=${t.length}`),Lt(e),te=setInterval(()=>{if(n>=t.length){ge({log:!1,silentIfIdle:!0}),f("preview end");return}const[a,l,o]=t[n++],s=Date.now();Ke.append(s,a),Qe.append(s,l),et.append(s,o)},1e3/_t)}function ge({log:e=!0,silentIfIdle:t=!1}={}){const n=!!te||N!==null;te&&(clearInterval(te),te=null),N=null,e&&(n?f("preview stopped"):t||f("プレビュー再生中ではありません")),n&&(j?we(Y.labelIndex,Y.detail):M||ve())}function wn(e){if(N===null){f("プレビュー再生中ではありません");return}if(N!==e){f(`現在再生中のセグメントは #${N} です`);return}ge({log:!0})}function _n(e){if(!(e>=0&&e<y.length)){f("削除対象が不正です");return}ne=e;const t=i.querySelector("#confirmModal"),n=i.querySelector("#confirmMessage");if(n){const a=y[e];n.textContent=`セグメント #${e} (label=${L(a.lab)}, length=${a.seq.length}) を削除しますか？`}if(t){t.style.display="flex";const a=i.querySelector("#confirmCancel");a&&a.focus()}}function Ie(){const e=i.querySelector("#confirmModal");e&&(e.style.display="none")}function En(e){if(!(e>=0&&e<y.length)){f("削除対象が不正です");return}ge({log:!1,silentIfIdle:!0}),y.splice(e,1),f(`segment deleted: #${e}`),X(),J(),Z(),U(),O(),G(),Ee("セグメントを削除したため学習モデルをクリアしました")}function In(e){if(!(e>=0&&e<y.length)){f("ラベル編集対象が不正です");return}T=e;const t=i.querySelector("#labelModal"),n=i.querySelector("#labelEditMessage"),a=i.querySelector("#labelEditSelect"),l=i.querySelector("#labelEditNameInput"),o=y[e];if(n&&(n.textContent=`セグメント #${e} / 現在: ${L(o.lab)}`),a){Z();const s=String(o.lab);let d=Array.from(a.options||[]).find(p=>p.value===s);d||(d=document.createElement("option"),d.value=s,d.textContent=L(o.lab),a.appendChild(d)),a.value=s,setTimeout(()=>{a.focus()},0)}l&&(l.value=le(o.lab)||""),O(),t&&(t.style.display="flex")}function he(){const e=i.querySelector("#labelModal");e&&(e.style.display="none")}function Cn(){if(!(T>=0&&T<y.length)){T=null,he();return}const e=i.querySelector("#labelEditSelect"),t=i.querySelector("#labelEditNameInput"),n=parseInt(e&&e.value,10);if(!isFinite(n)||n<0){f("ラベルは 0 以上の整数を選択してください"),e&&e.focus();return}const a=T;T=null,he();const l=y[a].lab;y[a].lab=n;const o=l!==n,s=t?t.value:"",d=at(n,s,{allowEmptyClear:!0});if(!o&&!d){f(`変更はありません (#${a})`),X(),J(),Z(),U(),O(),G();return}o&&(f(`segment label updated: #${a} ${l} -> ${n}`),Ee("セグメントのラベルを変更したため学習モデルをクリアしました")),d&&f(`label display updated: label=${L(n)}`),X(),J(),Z(),U(),O(),G()}D.onScan=e=>{B("devName",e||"-",!!e),B("state","scanned",!1),P=!1},D.onConnectGATT=()=>{B("state","connected",!0),P=!1},D.onStartNotify=()=>{B("state","notifying",!0),P=!0,f("notify started")},D.onStopNotify=()=>{B("state","stopped",!1),P=!1,f("notify stopped")},D.onRead=e=>{if(te)return;const t=e.getInt16(0,!0)/1e3,n=e.getInt16(2,!0)/1e3,a=e.getInt16(4,!0)/1e3,l=Date.now();if(Ke.append(l,t),Qe.append(l,n),et.append(l,a),tt.length!==100&&(tt=new Float32Array(100),Et=new Float32Array(100),It=new Float32Array(100),Q=0),tt[Q]=t,Et[Q]=n,It[Q]=a,Q=(Q+1)%100,M&&ee.push([t,n,a]),j&&de&&R&&E!=null){const o=dn([t,n,a]),d=[1,...R.step(o)],p=numeric.dot(d,R.W_out),u=$(Array.from(p)),r=parseFloat(i.querySelector("#emaAlpha").value||"0.1");if(!E)E=u.slice();else for(let c=0;c<u.length;c++)E[c]=(1-r)*E[c]+r*u[c];const m=E.indexOf(Math.max(...E));we(m,"["+E.map(c=>c.toFixed(2)).join(", ")+"]",{suppressUI:N!==null})}},i.querySelector("#btnConnect").onclick=()=>D.startNotify("ACC"),i.querySelector("#btnStop").onclick=()=>D.stopNotify("ACC"),i.querySelector("#btnRecStart").onclick=()=>{if(!P){const l="先に接続をお願いします";f(l),H(l);return}if(ye("波形取得",{checkRecord:!1}))return;if(M){f("既に録音中です");return}if(F){clearTimeout(F),F=null,G(),f("カウントダウンをキャンセルしました");return}const e=vn();F&&(clearTimeout(F),F=null),A&&(clearInterval(A),A=null);let t=3;Mt(String(t));const n=()=>{F=null,fn(),M=!0,ee=[],Ct=performance.now(),f(`recording started (${e.toFixed(1)}s予定)`),A&&clearInterval(A),A=setInterval(()=>{const l=(performance.now()-Ct)/1e3;if(mn(l),l>=e){bn({save:!0,reason:`録音を自動停止 (${e.toFixed(1)}s)`});return}},100)},a=()=>{t>1?(t--,Mt(String(t)),F=setTimeout(a,1e3)):n()};F=setTimeout(a,1e3)},i.querySelector("#btnTrain").onclick=async()=>{if(ye("学習"))return;nt=!0;const e=i.querySelector("#splitRatio");let t=parseFloat(e&&e.value);isFinite(t)||(t=1),t=Math.min(Math.max(t,.5),1),Zt(`学習＋評価中...

「ページが応答しません」と出た場合は、そのまま待つか「待機」を押してください`),await new Promise(n=>setTimeout(n,10));try{if(y.length===0){const c="収録データがありません。波形を保存してから学習してください。";f(c),H(c);return}const n=hn();if(!n.length){f("使用する軸を少なくとも1つ選択してください");return}xe=n.slice();const a=gn(),l=await sn("train",{segments:y.map(c=>({lab:c.lab,seq:c.seq})),selectedAxes:xe,params:a,trainRatio:t,shuffleSeed:Rt.toString()});Rt=BigInt(l.shuffleSeed);const o=l.esn;de=cn([]),R=new q(o.nIn,o.nRes,o.nOut,{spectralRadius:a.spectralRadius,density:a.density,leak:a.leak,seed:0}),R.W_in=new Float32Array(o.W_in),R.W_res=new Float32Array(o.W_res),R.W_out=o.W_out,qt={...a},E=null,_e(!0);const s=typeof l.trainRatio=="number"&&isFinite(l.trainRatio)?l.trainRatio:t,d=Math.round(s*100),p=Math.round((1-s)*100),u=typeof l.trainSegments=="number"?l.trainSegments:l.trainResult?l.trainResult.count:0,r=typeof l.evalSegments=="number"?l.evalSegments:l.evalResult?l.evalResult.count:0,m=!!(l.evalResult&&l.evalResult.usingTrainData);if(f(`trained: segments=${y.length}, dataset(train)=${u}, dataset(eval)=${r}${m?" [train data]":""}, split=${d}:${p}, classes=${o.nOut}, axes=${Sn(xe)}, ESN={nRes:${a.nRes}, radius:${a.spectralRadius.toFixed(2)}, leak:${a.leak.toFixed(2)}, density:${a.density.toFixed(2)}, ridge:${a.ridge.toExponential(1)}}`),l.trainResult&&f(`train split: N=${l.trainResult.count}, acc=${(l.trainResult.acc*100).toFixed(1)}%`),l.evalResult){const c=l.evalResult;f(`eval split${c.usingTrainData?" (train data)":""}: N=${c.count}, acc=${(c.acc*100).toFixed(1)}%`);const g=i.querySelector("#evalAccuracy");if(g){const b=isFinite(c.acc)?`${(c.acc*100).toFixed(1)}%${c.usingTrainData?" (train data)":""}`:"-";g.textContent=b}if(c.conf&&c.labels){let b=`Confusion Matrix [true x pred]
`;b+="      "+c.labels.map(S=>String(S).padStart(4," ")).join("")+`
`;for(let S=0;S<c.labels.length;S++)b+=String(c.labels[S]).padStart(4," ")+" "+c.conf[S].map(k=>String(k).padStart(4," ")).join("")+`
`;f(b.trim())}g&&me(g,isFinite(c.acc))}}catch(n){console.error(n),f("学習に失敗しました"),_e(!1)}finally{nt=!1,Ut()}},i.querySelector("#btnInferStart").onclick=()=>{if(ye("推論",{checkInfer:!1}))return;if(!P){const n="先に接続をお願いします";f(n),H(n);return}if(!R||!de){const n="学習してから推論開始してください";f(n),H(n);return}const e=R.W_out[0].length;E=new Array(e).fill(0),j=!0;const t=i.querySelector("#btnInferStop");t&&t.focus(),we(null,"-"),f("inference started")},i.querySelector("#btnInferStop").onclick=()=>{j=!1,Y={labelIndex:null,detail:"-"},f("inference stopped"),B("state",P?"notifying":"idle",P),!M&&N===null&&ve()},i.querySelector("#btnZip").onclick=async()=>{if(ye("ZIPダウンロード"))return;if(y.length===0){f("出力するセグメントがありません");return}const e=new JSZip,t=i.querySelector("#noteInput").value||"",n={};Object.keys(ae).forEach(b=>{const S=parseInt(b,10),k=le(S);k&&(n[String(S)]=k)});const a={fs:_t,note:t,labelNames:n,segments:[]};y.forEach((b,S)=>{const k=`seg_${String(S).padStart(4,"0")}_lab${b.lab}.csv`;a.segments.push({label:b.lab,file:k,n:b.seq.length});const ct=["x,y,z",...b.seq.map(W=>`${W[0]},${W[1]},${W[2]}`)];e.file(k,ct.join(`
`))}),e.file("meta.json",JSON.stringify(a,null,2));const l=await e.generateAsync({type:"blob"}),o=new Date,s=o.getFullYear(),d=String(o.getMonth()+1).padStart(2,"0"),p=String(o.getDate()).padStart(2,"0"),u=String(o.getHours()).padStart(2,"0"),r=String(o.getMinutes()).padStart(2,"0"),m=String(o.getSeconds()).padStart(2,"0"),c=`${s}${d}${p}-${u}${r}${m}_dataset_sensor.zip`,g=document.createElement("a");g.href=URL.createObjectURL(l),g.download=c,g.click(),URL.revokeObjectURL(g.href),f("ZIPダウンロード作成完了")},be&&be.addEventListener("change",async()=>{const e=be;if(ye("ZIPインポート")){e&&(e.value="");return}const t=e&&e.files&&e.files[0];if(Pt&&(Pt.textContent=t?t.name:"選択されていません"),!t){f("ZIPを選択してください");return}Zt("importing..."),await new Promise(n=>setTimeout(n,10));try{const n=await JSZip.loadAsync(t),a=JSON.parse(await n.file("meta.json").async("string")),l=[];for(const s of a.segments){const u=(await n.file(s.file).async("string")).trim().split(/\r?\n/).slice(1).map(m=>m.split(",").map(Number)),r=Number.isFinite(s.label)?s.label:parseInt(s.label,10);l.push({lab:Number.isNaN(r)?0:r,seq:u})}ge({log:!1,silentIfIdle:!0}),y=l,ae={},a.labelNames&&typeof a.labelNames=="object"&&Object.entries(a.labelNames).forEach(([s,d])=>{const p=parseInt(s,10);Number.isNaN(p)||typeof d=="string"&&d.trim()&&(ae[p]=d.trim())}),X(),J(),Z(),U(),O(),G(),f("ZIPインポート完了: "+y.length+" セグメント");const o=i.querySelector("#noteInput");o&&(o.value=a.note||""),a.note&&f("メモ: "+a.note),Ee("ZIPをインポートしたため学習モデルをクリアしました")}catch(n){console.error(n),f("ZIPインポート失敗")}finally{Ut(),e&&(e.value="")}}),rn(),_e(!1),ve(),X(),J(),Z(),U(),O()}Rn(()=>{if(typeof window>"u")return;let _=!1;return typeof document<"u"&&document.body.classList.remove("mode-basic","mode-advanced"),dt("demo2Root"),(async()=>{for(const w of Kt){if(_)return;await Qt(w)}_||en("demo2Root")})().catch(w=>{console.error("[demo2] failed to initialize scripts",w)}),()=>{_=!0}}),An();var Re=Tn();$n("rw1ls8",_=>{var w=Fn();oe(2),Mn(()=>{Ln.title="micro:bit WebBluetooth + ESN — Record/Train/Eval/Infer (raw xyz)"}),Jt(_,w)});var Ne=v(I(Re),4),ut=I(Ne),pt=v(I(ut),4),ft=v(I(pt),2),ke=I(ft);ke.value=ke.__value="0";var Me=v(ke);Me.value=Me.__value="1";var Le=v(Me);Le.value=Le.__value="2";var $e=v(Le);$e.value=$e.__value="3";var Ae=v($e);Ae.value=Ae.__value="4";var Fe=v(Ae);Fe.value=Fe.__value="5";var Te=v(Fe);Te.value=Te.__value="6";var Oe=v(Te);Oe.value=Oe.__value="7";var We=v(Oe);We.value=We.__value="8";var mt=v(We);mt.value=mt.__value="9",C(ft),C(pt),oe(6),C(ut),C(Ne);var vt=v(Ne,4),yt=v(I(vt),8),ze=v(I(yt),2),bt=v(I(ze),4),De=I(bt);De.value=De.__value="0";var je=v(De);je.value=je.__value="1";var Pe=v(je);Pe.value=Pe.__value="2";var Be=v(Pe);Be.value=Be.__value="3";var Ze=v(Be);Ze.value=Ze.__value="4";var Ue=v(Ze);Ue.value=Ue.__value="5";var Ve=v(Ue);Ve.value=Ve.__value="6";var Ye=v(Ve);Ye.value=Ye.__value="7";var Je=v(Ye);Je.value=Je.__value="8";var gt=v(Je);gt.value=gt.__value="9",C(bt),oe(4),C(ze);var ht=v(ze,8),St=v(I(ht),2),xt=v(I(St),2),Ge=I(xt);Ge.value=Ge.__value="1.0";var He=v(Ge);He.value=He.__value="0.9";var Xe=v(He);Xe.value=Xe.__value="0.8";var wt=v(Xe);wt.value=wt.__value="0.7",C(xt),C(St),oe(6),C(ht),oe(8),C(yt),oe(4),C(vt),C(Re),Jt(Ht,Re),kn()}export{Bn as component};
