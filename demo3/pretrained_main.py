# main.py — micro:bit (MicroPython) ESN リアルタイム推論（完全オンライン / CSR + int8）
import microbit
import math

MG2G = 1.0 / 1000.0

# ----------------------------
# tanh（MicroPythonにmath.tanhが無い場合があるため）
# ----------------------------
def _tanh(z):
    if z > 8.0:
        return 1.0
    if z < -8.0:
        return -1.0
    e = math.exp(2.0 * z)
    return (e - 1.0) / (e + 1.0)

# =========================================================
# ここにPC側で出力したモデル定数を貼り付け
# N,K,M, RES_ROW_PTR, RES_COL_IDX, RES_VAL_Q, RES_SCALE,
# IN_VAL_Q, IN_SCALE,
# W_OUT_Q, W_OUT_SCALE,
# B_RES_Q, B_RES_SCALE,
# LEAK, ADD_BIAS, MEAN, SCALE, CLASSES
# =========================================================
N = 100
K = 3
M = 3
RES_ROW_PTR = [0, 8, 18, 25, 30, 34, 36, 37, 43, 52, 58, 64, 65, 69, 73, 79, 81, 84, 89, 91, 92, 94, 96, 98, 104, 109, 112, 115, 119, 128, 132, 136, 137, 145, 151, 154, 156, 164, 172, 183, 185, 189, 192, 199, 202, 205, 210, 214, 221, 224, 231, 236, 237, 244, 249, 252, 258, 262, 267, 271, 273, 277, 283, 289, 289, 290, 296, 301, 307, 313, 317, 321, 325, 329, 338, 346, 354, 361, 363, 368, 370, 374, 380, 385, 392, 398, 405, 411, 417, 418, 420, 426, 428, 431, 431, 433, 437, 439, 440, 442, 445]
RES_COL_IDX = [5, 30, 31, 59, 68, 70, 79, 80, 3, 17, 39, 51, 52, 56, 58, 61, 96, 98, 32, 39, 72, 77, 84, 86, 87, 40, 41, 64, 65, 74, 32, 37, 83, 89, 17, 20, 59, 18, 21, 27, 70, 88, 98, 2, 18, 26, 40, 48, 54, 86, 92, 96, 14, 49, 55, 61, 65, 87, 24, 45, 48, 69, 84, 88, 70, 19, 21, 48, 50, 4, 10, 68, 92, 18, 23, 55, 79, 83, 88, 41, 45, 6, 14, 93, 4, 13, 58, 81, 92, 19, 67, 96, 24, 68, 4, 69, 53, 57, 17, 18, 29, 35, 37, 48, 6, 22, 50, 68, 71, 14, 48, 76, 14, 59, 75, 13, 16, 53, 86, 24, 26, 40, 46, 57, 58, 86, 89, 91, 11, 40, 86, 99, 8, 19, 22, 68, 82, 14, 15, 42, 65, 72, 73, 79, 90, 31, 43, 48, 75, 76, 93, 72, 83, 95, 6, 50, 8, 18, 29, 35, 37, 48, 61, 82, 1, 2, 8, 9, 55, 72, 83, 84, 13, 14, 43, 50, 62, 72, 78, 80, 83, 84, 94, 10, 47, 5, 13, 53, 81, 6, 34, 82, 3, 18, 34, 40, 46, 92, 94, 2, 7, 14, 13, 40, 82, 7, 13, 19, 33, 57, 22, 49, 54, 65, 8, 14, 19, 31, 49, 53, 67, 10, 44, 92, 49, 54, 64, 83, 85, 86, 88, 16, 35, 58, 62, 79, 7, 1, 11, 12, 24, 60, 72, 93, 24, 56, 72, 78, 88, 20, 32, 81, 7, 17, 40, 69, 88, 93, 6, 19, 82, 92, 11, 16, 25, 70, 71, 6, 57, 61, 97, 2, 57, 6, 16, 50, 97, 41, 50, 79, 80, 85, 96, 14, 17, 27, 30, 66, 86, 58, 27, 37, 42, 62, 67, 91, 35, 82, 90, 93, 97, 5, 25, 29, 38, 50, 78, 7, 14, 24, 40, 53, 62, 53, 66, 73, 96, 29, 32, 78, 93, 7, 14, 40, 92, 4, 43, 60, 69, 1, 10, 18, 20, 22, 54, 71, 73, 86, 15, 16, 23, 30, 54, 66, 67, 74, 0, 8, 13, 15, 19, 47, 65, 69, 28, 38, 39, 48, 49, 57, 79, 20, 63, 36, 54, 56, 68, 79, 13, 64, 3, 33, 44, 91, 36, 47, 49, 70, 86, 94, 7, 12, 33, 88, 96, 25, 26, 36, 46, 68, 84, 85, 27, 29, 34, 76, 85, 88, 7, 17, 21, 28, 38, 62, 91, 3, 22, 56, 68, 88, 97, 6, 28, 31, 36, 71, 86, 14, 55, 89, 3, 39, 57, 64, 67, 70, 42, 53, 41, 66, 75, 20, 36, 17, 23, 50, 90, 15, 50, 82, 17, 80, 59, 61, 71]
RES_VAL_Q = [117, -53, -24, -104, 41, 51, 86, -67, 94, 124, -38, -92, -2, -82, -100, -54, 55, -85, -113, 113, -98, -45, -81, -69, 60, -122, -126, 71, 94, 127, 99, -72, 92, -95, 102, -34, -52, -56, 59, 92, -74, 4, -16, -58, 124, -114, 108, 99, 21, -75, 25, -97, 39, -94, 31, -41, -61, 106, 126, -40, -126, 36, 93, 57, -44, -29, -23, 31, 26, -81, 61, -30, 64, -48, 21, 77, 66, 50, 61, 104, 12, 111, -71, -43, 37, 93, -20, 11, -85, 76, 31, 7, -4, -86, 12, -103, -97, -13, 43, -13, 29, -108, -91, 120, -123, -33, -14, 115, 92, -42, 49, -65, -84, 115, -22, -114, -122, -36, 116, -58, 22, -39, 89, 19, 55, 82, 58, -127, 115, -88, 7, -76, -6, -64, -30, -111, -36, 44, 27, 43, -8, 30, 106, 67, -71, -68, 118, 82, -77, -83, 47, 48, 18, 75, -100, 76, -34, 69, 122, -38, -81, 109, 21, 102, -74, 116, -120, -102, 76, 104, 112, -64, 55, 39, -33, -61, -121, -102, 83, -82, -89, 37, 21, -5, -83, -114, 55, 46, -69, -124, 40, 44, -15, 19, -26, -34, 48, 97, 26, 104, 77, -65, 25, 47, -34, 15, 86, 126, 17, -123, -37, -116, -38, -45, 7, 21, -62, -43, -35, -111, 37, 29, -118, 21, 115, -70, 39, -39, -106, 1, 84, 112, 81, -117, 93, -30, 41, -75, 109, 100, -68, -63, -86, 58, 67, 122, -118, -121, 96, 8, -63, 26, -127, 99, -78, 32, 114, -111, 79, -12, 30, -45, -43, 44, -85, 3, 120, 82, 57, 5, 81, -25, 46, -108, -78, -102, -20, -73, 19, 109, -33, -114, 98, 104, -25, -101, -75, -10, 98, 79, -115, -104, 124, -54, -115, 89, 76, 88, -82, 95, -107, 54, 107, -38, -45, -25, -51, 81, -83, -101, 73, -89, -40, -70, 84, -61, 21, 28, -112, -3, 112, -57, -56, 6, -83, -21, 87, 116, 4, 98, -84, 122, -36, 17, 4, -91, 62, 91, 86, 9, 56, -35, 7, 121, -91, -126, -51, -118, -122, -18, 11, -68, -18, -97, -90, 120, -115, 32, -102, 91, 115, 83, 64, -91, 9, 89, -24, -91, -16, -114, -93, -103, 32, 16, -85, -89, -50, 70, 36, -44, -90, 102, 12, -50, 103, -16, -113, 126, -114, 89, -77, 117, -17, -122, 111, 110, 28, 21, -18, 34, 101, -109, 66, 19, 107, 34, 13, 8, -76, 87, -48, 95, -10, -42, -67, -11, -86, -117, 26, 23, -6, -98, -22, 40, 71, -21, 49, 42, 76, 4, -110, -78, -34, 31, -24, 85, -120, -79, -80, -76, 120, 38, 83, 87, 72]
RES_SCALE = 0.008851939298975186
IN_VAL_Q = [-114, -71, -80, 79, 108, -57, 99, 3, -65, -73, 61, 33, -68, 76, 5, -85, -1, 21, -123, -7, 58, 32, 106, 93, 93, 59, -57, 93, -51, 7, 21, -67, 67, -48, -124, -119, -8, -95, -62, -30, 19, -19, 30, -60, 79, 66, 17, -16, -122, -8, 31, -16, -4, 5, 20, -109, -3, 62, -18, -50, 65, -108, -3, 87, 115, -46, -41, 79, 76, -69, -92, -19, 95, -82, -120, -18, 91, -86, 36, 110, -61, -89, 61, -53, -69, -33, -44, 11, 64, -52, 11, 46, 48, -90, -10, 6, -81, 1, 41, -72, 116, 57, 123, -125, -60, -107, 90, -90, 72, 101, -10, -47, -123, -38, -60, 39, 109, -75, 108, 113, 102, -53, -95, 66, -105, 67, -21, -91, 39, -27, 78, -10, 72, 29, 117, -72, 11, -65, 65, -60, -47, -25, -15, 107, 91, -8, -73, -107, -92, -59, -69, -20, -11, -82, -59, 90, -33, -10, -42, 48, 60, -47, 53, -15, 106, -120, 58, 124, 115, -86, -73, -24, 102, 120, 50, 32, 92, 16, 78, 70, 122, -120, -100, 21, -18, -111, -28, 1, 65, 83, 10, -36, -80, 99, 44, -74, -68, -11, -117, -38, 64, -68, 113, -107, 52, -110, 120, -94, 68, -20, -2, -125, -86, -81, -58, -108, 44, -14, 101, 46, 54, -15, 98, -33, -16, 14, 10, -17, 11, -30, 71, 56, -74, 110, -45, 102, -115, 109, 42, 18, -106, -104, 49, 3, -127, 84, -42, 46, -91, 54, 3, 23, 112, 73, 102, 122, 81, -102, -79, -42, -71, -14, -60, -10, -45, -117, 85, -65, 109, 60, -39, -109, -55, -108, -31, 23, 62, -53, -43, 58, -60, -5, -126, 91, 61, -24, 32, 114, -110, -41, -101, 73, -87, -32, 116, -43, -5, 72, 94, 43]
IN_SCALE = 0.006286381736515075
# ★ 変更：W_OUT / B_RES は int8 + scale
W_OUT_Q = [[2, 3, 0, 1, -1, 3, -1, 2, 1, 1, -6, 0, -8, 1, 5, 1, -1, 4, 5, 23, 6, 5, -3, 1, 0, -7, 4, 3, 0, 4, -4, -9, -2, 1, -1, 4, 0, 0, -1, 2, -3, -5, 4, -2, -4, 9, 0, 4, 7, 0, -5, 7, 2, 2, 3, -1, 12, -6, 8, 7, -1, -2, 2, -45, 7, 0, 3, 0, -3, -5, -1, -8, -3, 8, 2, 0, 0, 2, 5, 8, 0, -1, -2, -1, -1, 3, -4, -1, 2, 2, -2, 4, -4, 10, 0, 4, 12, 6, -4, 1, -3], [-10, -8, -2, -5, 5, -18, -10, 3, -2, 0, 14, -21, 7, -16, -12, -12, -5, -4, -5, -93, 0, -9, 9, -10, -5, 4, -17, 13, 3, -11, -2, 63, -2, 2, -14, -7, 2, -2, -2, -7, -9, 11, 22, 2, 8, -3, -1, -9, -11, -1, 0, -13, 3, -2, -13, -1, 13, 0, -5, -29, 2, 12, -3, 127, -27, -2, -11, 9, -1, 8, 7, 13, -5, -5, -1, 4, 4, 5, 3, -20, -3, -4, -6, 7, -1, 0, 10, 2, 6, 12, 5, 18, 10, -16, 12, 2, -11, -7, 16, 8, 24], [8, 5, 1, 4, -5, 16, 11, -5, 1, -1, -8, 21, 1, 16, 7, 11, 6, 1, 0, 70, -6, 4, -7, 9, 5, 3, 13, -16, -3, 7, 5, -55, 4, -3, 15, 4, -2, 2, 3, 5, 12, -6, -26, 0, -5, -5, 1, 5, 4, 0, 5, 6, -4, 0, 10, 2, -24, 7, -3, 22, 0, -10, 1, -82, 20, 2, 7, -9, 4, -3, -6, -5, 8, -3, -2, -4, -4, -8, -8, 12, 3, 5, 8, -6, 2, -3, -6, -1, -9, -14, -3, -22, -6, 7, -12, -5, -1, 1, -12, -9, 20]]
W_OUT_SCALE = 0.024357309491615596
B_RES_Q = [47, -83, 82, 83, 109, -69, -81, 107, -72, 76, -110, -83, -1, -127, 86, 0, -27, 114, -23, 28, -126, -50, 102, 40, -89, 15, -36, 48, -66, 29, 118, -89, -58, -69, -119, 107, -82, -118, 41, -9, -93, -98, -67, -11, 49, 13, -107, 125, 74, -111, 71, -49, 126, -34, -91, -23, -9, -41, 3, -100, 68, -89, -56, -3, 78, 116, -90, 99, -108, -58, 102, -102, 97, 29, -53, -57, -38, -89, -29, 122, 6, 117, 84, -86, 6, -53, -106, -115, 72, -2, -20, 55, 61, -88, 102, 37, -103, 107, -22, 7]
B_RES_SCALE = 0.006259135843261959
LEAK = 1.0
ADD_BIAS = True
MEAN = [-0.015935609117150307, -0.020882578566670418, -1.0278249979019165]
SCALE = [0.2952824831008911, 0.13869890570640564, 0.3072218894958496]
CLASSES = [0, 1, 2]
# =========================================================

# ----------------------------
# 推論設定（完全オンライン用）
# ----------------------------
SAMPLE_MS = 10
WARMUP_FRAMES = 20
EMA_BETA = 0.20
DEBOUNCE = 3
MARGIN = 0.0

# ----------------------------
# 標準化（PC側 MEAN/SCALE と一致させる）
# ----------------------------
def standardize_vec(u):
    if MEAN is None or SCALE is None:
        return u[:]
    out = [0.0] * K
    for i in range(K):
        s = SCALE[i] if SCALE[i] != 0 else 1.0
        out[i] = (u[i] - MEAN[i]) / s
    return out

# ----------------------------
# ESN 1 step（CSR + int8）
# x: (N,) state
# u: (K,) standardized input
# ----------------------------
def esn_step_inplace(x, u):
    pre = [0.0] * N
    for i in range(N):
        s = 0.0

        # Reservoir W*x (CSR)
        start = RES_ROW_PTR[i]
        end   = RES_ROW_PTR[i + 1]
        for p in range(start, end):
            j = RES_COL_IDX[p]
            s += (RES_VAL_Q[p] * RES_SCALE) * x[j]

        # Input Win*u (dense int8, row-major flat)
        base = i * K
        for kk in range(K):
            s += (IN_VAL_Q[base + kk] * IN_SCALE) * u[kk]

        # Bias (int8 + scale)
        s += (B_RES_Q[i] * B_RES_SCALE)

        pre[i] = s

    # tanh + leak
    if LEAK == 1.0:
        for i in range(N):
            x[i] = _tanh(pre[i])
    else:
        for i in range(N):
            xn = _tanh(pre[i])
            x[i] = (1.0 - LEAK) * x[i] + LEAK * xn

# ----------------------------
# 1フレーム推論（完全オンライン）
# scores: (M,)
# ----------------------------
def linear_scores_from_state(x):
    scores = [0.0] * M
    for m in range(M):
        row_q = W_OUT_Q[m]  # length N (+bias at N)
        s = 0.0
        for i in range(N):
            s += (row_q[i] * W_OUT_SCALE) * x[i]
        if ADD_BIAS:
            s += (row_q[N] * W_OUT_SCALE)
        scores[m] = s
    return scores

def argmax_and_margin(scores):
    best = 0
    bestv = scores[0]
    secondv = -1e30
    for i in range(M):
        v = scores[i]
        if v > bestv:
            secondv = bestv
            bestv = v
            best = i
        elif v > secondv:
            secondv = v
    return best, (bestv - secondv)

# ----------------------------
# 表示
# ----------------------------
def show_label(lbl):
    try:
        n = int(lbl)
    except:
        n = 0
    if n == 0:
        microbit.display.show('0')
    elif n == 1:
        microbit.display.show('1')
    elif n == 2:
        microbit.display.show('2')
    else:
        microbit.display.show('?')

# =========================================================
# main loop（完全オンライン）
# =========================================================
x_state = [0.0] * N

# EMAの状態
z_ema = None

# debounce状態
last_shown = None
cand = None
cand_count = 0

microbit.display.show('?')

frame = 0
while True:
    ax = microbit.accelerometer.get_x() * MG2G
    ay = microbit.accelerometer.get_y() * MG2G
    az = microbit.accelerometer.get_z() * MG2G

    u_std = standardize_vec([ax, ay, az])

    # state update
    esn_step_inplace(x_state, u_std)

    # warmup中は表示しない
    frame += 1
    if frame < WARMUP_FRAMES:
        microbit.sleep(SAMPLE_MS)
        continue

    # scores
    z = linear_scores_from_state(x_state)

    # EMA
    if z_ema is None:
        z_ema = z[:]
    else:
        b = EMA_BETA
        for i in range(M):
            z_ema[i] = (1.0 - b) * z_ema[i] + b * z[i]

    # predict with margin
    pred, gap = argmax_and_margin(z_ema)

    # マージンが小さい場合は切替抑制（last_shown維持）
    if MARGIN > 0.0 and last_shown is not None and gap < MARGIN:
        pred = last_shown

    # debounce
    if cand is None:
        cand = pred
        cand_count = 1
    else:
        if pred == cand:
            cand_count += 1
        else:
            cand = pred
            cand_count = 1

    if cand_count >= DEBOUNCE:
        # class index -> label
        try:
            out_label = CLASSES[cand]
        except:
            out_label = cand

        if out_label != last_shown:
            show_label(out_label)
            last_shown = out_label

    microbit.sleep(SAMPLE_MS)